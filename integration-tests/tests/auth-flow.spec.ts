/**
 * èªè¨¼ãƒ•ãƒ­ãƒ¼E2Eãƒ†ã‚¹ãƒˆ
 *
 * OIDCèªå¯ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ã®å®Œå…¨ãªE2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã€‚
 * - ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆï¼ˆCognito Admin APIï¼‰
 * - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‹ã‚‰ã®èªè¨¼
 * - å£åº§ä½œæˆAPIã®å‘¼ã³å‡ºã—
 * - å£åº§ç•ªå·ã®è¡¨ç¤ºç¢ºèª
 * - ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰Šé™¤ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
 */
import { test, expect } from '@playwright/test'

import { createTestUser, deleteTestUser, generateTestEmail } from '../setup/test-user'

/**
 * ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼æƒ…å ±
 */
const TEST_PASSWORD = 'TestPassword123!'

test.describe('AUTH-001: èªè¨¼ãƒ•ãƒ­ãƒ¼å®Œå…¨E2Eãƒ†ã‚¹ãƒˆ', () => {
  /** ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ */
  let testEmail: string

  /**
   * ãƒ†ã‚¹ãƒˆå‰å‡¦ç†: ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
   */
  test.beforeEach(async () => {
    // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç”Ÿæˆ
    testEmail = generateTestEmail()

    console.log(`ğŸ”§ ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆä¸­: ${testEmail}`)

    // Cognito Admin API ã§ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
    // - ãƒ¡ãƒ¼ãƒ«ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆemail_verified: trueï¼‰
    // - åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆPermanent: trueï¼‰
    await createTestUser(testEmail, TEST_PASSWORD)

    console.log(`âœ… ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå®Œäº†: ${testEmail}`)
  })

  /**
   * ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†: ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
   */
  test.afterEach(async () => {
    console.log(`ğŸ§¹ ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ä¸­: ${testEmail}`)

    // Cognito Admin API ã§ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
    await deleteTestUser(testEmail)

    console.log(`âœ… ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å®Œäº†: ${testEmail}`)
  })

  /**
   * ãƒ­ã‚°ã‚¤ãƒ³ã‹ã‚‰å£åº§ç•ªå·è¡¨ç¤ºã¾ã§ã®å®Œå…¨ãªãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ
   *
   * ãƒ•ãƒ­ãƒ¼:
   * 1. ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
   * 2. ã€Œå£åº§ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   * 3. Cognitoãƒ›ã‚¹ãƒˆ UIã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
   * 4. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
   * 5. /callback ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
   * 6. å£åº§ç•ªå·ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
   */
  test('ãƒ­ã‚°ã‚¤ãƒ³ã‹ã‚‰å£åº§ç•ªå·è¡¨ç¤ºã¾ã§ã®å®Œå…¨ãƒ•ãƒ­ãƒ¼', async ({ page }) => {
    // ============================================================
    // Step 1: ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    // ============================================================
    console.log('ğŸ“ Step 1: ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹')

    await page.goto('/')
    await expect(page).toHaveTitle('OIDCå­¦ç¿’ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹')

    // ã€Œå£åº§ä½œæˆã€ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    const loginButton = page.getByRole('button', { name: 'å£åº§ä½œæˆ' })
    await expect(loginButton).toBeVisible()

    // ============================================================
    // Step 2: ã€Œå£åº§ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    // ============================================================
    console.log('ğŸ“ Step 2: ã€Œå£åº§ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯')

    // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾Œã€Cognitoã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
    await loginButton.click()

    // Cognito ãƒ›ã‚¹ãƒˆ UI ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    // URLã«ã€Œamazoncognito.comã€ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await page.waitForURL(/amazoncognito\.com/)

    console.log('âœ… Cognito ãƒ›ã‚¹ãƒˆ UI ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã—ãŸ')

    // ============================================================
    // Step 3: Cognitoãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›
    // ============================================================
    console.log('ğŸ“ Step 3: Cognitoãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›')

    // Cognito UIã«ã¯è¤‡æ•°ã®ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆSign in / Sign upï¼‰ãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€
    // å¯è¦–ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠã‚’ç‰¹å®šã—ã¦ã‹ã‚‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¢ã™
    // ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    await page.waitForSelector('input[placeholder="name@host.com"]:visible', { timeout: 10000 })

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›
    const usernameInput = page.locator('input[placeholder="name@host.com"]:visible')
    await usernameInput.fill(testEmail)

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›
    const passwordInput = page.locator('input[placeholder="Password"]:visible')
    await passwordInput.fill(TEST_PASSWORD)

    // ============================================================
    // Step 4: ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    // ============================================================
    console.log('ğŸ“ Step 4: ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯')

    // Cognitoã®ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ï¼ˆå¯è¦–ã®ã‚‚ã®ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯
    const submitButton = page.locator('input[name="signInSubmitButton"]:visible')
    await submitButton.click()

    // ============================================================
    // Step 5: /callback ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã®ã‚’å¾…æ©Ÿ
    // ============================================================
    console.log('ğŸ“ Step 5: /callback ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã®ã‚’å¾…æ©Ÿ')

    // CloudFront ã® URL ã«æˆ»ã‚Šã€/callback ãƒ‘ã‚¹ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
    await page.waitForURL(/\/callback$/)

    console.log('âœ… /callback ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã—ãŸ')

    // ============================================================
    // Step 6: èªè¨¼æˆåŠŸç”»é¢ã®è¡¨ç¤ºã‚’ç¢ºèª
    // ============================================================
    console.log('ğŸ“ Step 6: èªè¨¼æˆåŠŸç”»é¢ã®è¡¨ç¤ºã‚’ç¢ºèª')

    // ã€Œèªè¨¼æˆåŠŸã€ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page.getByText('èªè¨¼æˆåŠŸ')).toBeVisible()

    // ============================================================
    // Step 7: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    // ============================================================
    console.log('ğŸ“ Step 7: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª')

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    // ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå®Ÿéš›ã«è¡¨ç¤ºã•ã‚Œã‚‹
    await expect(page.getByText(testEmail)).toBeVisible()

    // ============================================================
    // Step 8: å£åº§ç•ªå·ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    // ============================================================
    console.log('ğŸ“ Step 8: å£åº§ç•ªå·ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª')

    // ã€Œå£åº§æƒ…å ±ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page.getByText('å£åº§æƒ…å ±')).toBeVisible()

    // ã€Œå£åº§ç•ªå·ã€ãƒ©ãƒ™ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page.getByText('å£åº§ç•ªå·')).toBeVisible()

    // å£åº§ç•ªå·ï¼ˆ10æ¡ã®æ•°å­—ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    // å£åº§ç•ªå·ã¯10æ¡ã®æ•°å­—ã§ã€é’è‰²ã®ãƒ†ã‚­ã‚¹ãƒˆã§è¡¨ç¤ºã•ã‚Œã‚‹
    const accountNumberElement = page.locator('.text-blue-600.font-mono')
    await expect(accountNumberElement).toBeVisible()

    // å£åº§ç•ªå·ã®å½¢å¼ã‚’æ¤œè¨¼ï¼ˆ10æ¡ã®æ•°å­—ï¼‰
    const accountNumber = await accountNumberElement.textContent()
    expect(accountNumber).toMatch(/^\d{10}$/)

    console.log(`âœ… å£åº§ç•ªå·ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ: ${accountNumber}`)

    // ============================================================
    // ãƒ†ã‚¹ãƒˆæˆåŠŸ
    // ============================================================
    console.log('ğŸ‰ èªè¨¼ãƒ•ãƒ­ãƒ¼E2Eãƒ†ã‚¹ãƒˆå®Œäº†')
  })
})

test.describe('AUTH-002: èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ', () => {
  /**
   * å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦ã¿ãŸå ´åˆã®ãƒ†ã‚¹ãƒˆ
   */
  test('å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
    // ============================================================
    // Step 1: ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€Œå£åº§ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    // ============================================================
    await page.goto('/')
    const loginButton = page.getByRole('button', { name: 'å£åº§ä½œæˆ' })
    await loginButton.click()

    // Cognito ãƒ›ã‚¹ãƒˆ UI ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    await page.waitForURL(/amazoncognito\.com/)

    // ============================================================
    // Step 2: å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦ã¿ã‚‹
    // ============================================================
    await page.waitForSelector('input[placeholder="name@host.com"]:visible', { timeout: 10000 })

    // å­˜åœ¨ã—ãªã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›
    const usernameInput = page.locator('input[placeholder="name@host.com"]:visible')
    await usernameInput.fill('nonexistent-user@example.com')

    // é©å½“ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›
    const passwordInput = page.locator('input[placeholder="Password"]:visible')
    await passwordInput.fill('WrongPassword123!')

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    const submitButton = page.locator('input[name="signInSubmitButton"]:visible')
    await submitButton.click()

    // ============================================================
    // Step 3: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    // ============================================================
    // Cognito ãƒ›ã‚¹ãƒˆ UI ã§ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
    // ã€ŒUser does not existã€ã¾ãŸã¯é¡ä¼¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const errorMessage = page.locator('#loginErrorMessage:visible')
    await expect(errorMessage).toBeVisible({ timeout: 10000 })

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹ã‚’ç¢ºèª
    await expect(errorMessage).toContainText(/User does not exist|Incorrect username or password/)

    console.log('âœ… å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª')
  })
})
