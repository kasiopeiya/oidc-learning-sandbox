# ドキュメントレビュースキル実装計画

## 概要

ドキュメントの品質をレビューし、改善提案を行うカスタムスキル `/doc-reviewer` を実装します。

## 実装方針

### アーキテクチャ

**ダイナミックディスパッチ型（単一エージェント）**を採用：

- 単一の `/doc-reviewer` スキルで全ドキュメントに対応
- ドキュメント種類を自動判定（ファイル名、ディレクトリ、セクション構造から判定）
- 判定結果に応じて適切なレビュー観点を動的に選択
- 汎用ドキュメント vs 設計書で異なるチェック項目を適用

### スコープ

**ドキュメント内容のみをレビュー**：

- ✅ ドキュメント内のテキスト、図表、構造をレビュー
- ✅ ドキュメント内のコード例（サンプルコード）をレビュー
- ❌ 実装コードとの整合性チェックは**対象外**（別コマンドで実装予定）
- ❌ シーケンス図と実際の実装の整合性は**対象外**

### ユーザー要件の実現

| 要件                     | 実現方法                                                             |
| ------------------------ | -------------------------------------------------------------------- |
| ファイル指定             | Phase 1でインタラクティブ選択（`docs/**/*.md` を検出し、番号で選択） |
| わかりやすい出力         | Markdown形式の詳細レポート（総合評価、良い点、改善点、次のステップ） |
| 設計の理由・背景チェック | Phase 3で設計書特有の観点として実装                                  |
| シーケンス図チェック     | Mermaidブロックの構文と妥当性を検証                                  |
| わかりやすさチェック     | Phase 3で全ドキュメント共通観点として実装                            |
| 対象読者と目的の必須化   | Phase 4で不記載時に減点、Phase 5で[必須]改善点として出力             |
| メンテナンス性の厳格化   | 同じ値の複数箇所記載、実装コード全文記載を減点対象に                 |
| 実装コード全文記載をNG化 | Phase 4で30行以上のコードブロックを検出、Phase 5で[推奨]改善点に     |

---

## ファイル構成

以下の2ファイルを新規作成：

### 1. `.claude/skills/doc-reviewer/SKILL.md`

**役割**: ユーザー向けスキル定義

**内容**:

- フロントマター（name, description）
- スキルの概要（4つの処理内容：検出、判定、選択、レポート生成）
- 使用方法（`/doc-reviewer` の実行例）
- 対象ドキュメント種別一覧
- レビュー観点一覧
- 使用技術（Glob, Read, Grep, Bash）

**参考**: `.claude/skills/git-commit/SKILL.md`

### 2. `.claude/agents/doc-reviewer-agent/doc-reviewer-agent.md`

**役割**: エージェント詳細定義

**内容**:

- フロントマター（name, description, tools: Read/Grep/Glob/Bash, model: sonnet）
- Phase 1〜5の詳細な実行フロー
- ドキュメント種類判定アルゴリズム
- レビュー観点の詳細定義
- 出力フォーマットの仕様

**参考**: `.claude/agents/git-commit-agent/git-commit-agent.md`

---

## Phase 別実行フロー

### Phase 1: ファイル検出とインタラクティブ選択

**ステップ**:

1. `Glob pattern: "docs/**/*.md"` でドキュメント検出
2. ファイル一覧をディレクトリ別にグループ化して表示
3. ユーザーが番号またはパスで選択
4. 入力検証（無効な番号、存在しないパス → 再入力）

**出力例**:

```
=== Document Review ===

Found 27 documentation files:

📁 Root Level
  1. docs/requirements.md
  2. docs/backend-design.md
  ...

Enter file number to review (1-27), or file path directly:
```

### Phase 2: ドキュメント種類の判定

**判定ロジック（優先順位順）**:

1. **ファイル名パターン**:
   - `requirements.md` → PRD
   - `*-design.md`, `*architecture*.md` → DESIGN/ARCHITECTURE
   - `implementation-plan.md` → PLAN

2. **ディレクトリパス**:
   - `docs/issues/` → ISSUE_SPEC
   - `docs/idea/` → PROPOSAL
   - `.claude/rules/` → GUIDELINE

3. **セクション構造**（ヘッダー分析）:
   - 「なぜ」「技術選定」「設計方針」→ DESIGN
   - 「要件」「ユースケース」→ PRD
   - 「システム構成」→ ARCHITECTURE

4. **デフォルト**: GENERAL

**対応種別**: PRD, ARCHITECTURE, DESIGN, PLAN, ISSUE_SPEC, GUIDELINE, PROPOSAL, GUIDE, GENERAL

### Phase 3: レビュー観点の選択

#### 全ドキュメント共通観点（6つ）

| 観点         | チェック内容                                             | スコア  |
| ------------ | -------------------------------------------------------- | ------- |
| 完全性       | 必要なセクションが揃っているか                           | 3点満点 |
| 明確性       | 曖昧な表現がないか、用語が明確か                         | 3点満点 |
| 一貫性       | 表記揺れ、矛盾がないか                                   | 3点満点 |
| 構造         | 階層構造が適切で読みやすいか                             | 3点満点 |
| 実装可能性   | 実装者が理解できる具体性があるか                         | 3点満点 |
| わかりやすさ | 対象読者の視点で理解しやすいか、前提知識への配慮があるか | 3点満点 |

#### 設計書特有観点（ユーザー要望）

| 観点                     | チェック内容                                                             | 重要度 |
| ------------------------ | ------------------------------------------------------------------------ | ------ |
| **設計の理由・背景**     | 「なぜこの設計にしたのか」が記載されているか                             | 必須   |
| 技術選定の根拠           | 「なぜこの技術を選んだのか」の説明                                       | 必須   |
| トレードオフの明示       | メリット・デメリットの記載                                               | 推奨   |
| **シーケンス図の妥当性** | Mermaid構文、autonumber、Note、参加者定義（※実装との整合性は別コマンド） | 重要   |

#### ドキュメント種別ごとの特別観点

- **PRD**: ターゲットユーザー、解決する課題の具体性
- **ARCHITECTURE**: AWSリソース構成、コスト見積もり、**セキュリティ考慮事項**
- **DESIGN**: 設計の理由・背景（必須）、**API設計が具体的か（該当する場合）**
- **PLAN**: 依存関係、受け入れ基準
- **ISSUE_SPEC**: AC（受け入れ基準）のチェックリスト形式

#### ドキュメント品質観点（全ドキュメント）

| 観点               | チェック内容                                                                                                                                                                                 | スコア  |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- |
| **メンテナンス性** | 具体的な数値が複数箇所にハードコードされていないか<br>同じ内容が複数ドキュメントに重複していないか<br>**設計書に実装コード全文を載せていないか**（関数シグネチャと処理概要のみ記載すること） | 3点満点 |
| **図表の活用**     | 文章だけでなく図や表で直感的に理解できるか<br>Mermaid記法やMarkdownテーブルの積極活用                                                                                                        | 3点満点 |
| **対象読者と目的** | ドキュメント冒頭に対象読者と目的が明記されているか                                                                                                                                           | 3点満点 |
| **目次**           | 500行以上のドキュメントに目次が記載されているか                                                                                                                                              | 推奨    |

**メンテナンス性の具体例**:

- ❌ 悪い例1: 「TTLは300秒」「5分後に削除」（同じ値が複数箇所にハードコード）
- ✅ 良い例1: 「セッションTTLは5分（300秒）」と1箇所で定義し、他は参照
- ❌ 悪い例2: 設計書に `session.ts` の実装コード全文（50行以上）を掲載
- ✅ 良い例2: 主要な関数のシグネチャと処理概要のみ記載、詳細は実装コードに委ねる

#### レビューの姿勢

レビュー実行時は以下の姿勢を徹底すること：

- **建設的**: 批判ではなく、改善のための提案を行う
- **具体的**: 「わかりにくい」ではなく、「どこが」「なぜ」「どう改善するか」を明示
- **バランス**: 悪い点だけでなく、良い点も必ず指摘する
- **実用的**: 実際に実行可能な改善案を提示する
- **根拠**: 改善提案には必ず理由を添える

**出力例**:

- ❌ 悪い例: 「この部分がわかりにくい」
- ✅ 良い例: 「2.3節の『適宜リトライする』という表現は曖昧です。『3回までリトライし、それでも失敗した場合はエラーを返す』のように具体的な条件を明記することで、実装者が迷わず実装できます」

### Phase 4: レビュー実行

**ステップ**:

1. **ドキュメント読み取り**: `Read` で全文取得（行数もカウント）
2. **コンテキスト収集**: `git log --oneline --follow -- <file>` で変更履歴確認
3. **各観点の評価**:
   - 完全性: 必要セクションの有無チェック
   - 明確性: 曖昧な表現（「適宜」「など」等）検出、専門用語の定義チェック
   - 一貫性: 表記揺れ（RP/Relying Party、API Gateway/API GW等）検出
   - **わかりやすさ**:
     - 対象読者の前提知識レベルに応じた説明がなされているか
     - 例: 対象読者がアプリケーションエンジニアの場合、AWSサービス（Lambda、DynamoDB等）の解説があるか
     - 技術用語に対する補足説明の有無
   - 設計の理由・背景: 「なぜ」「理由」「背景」キーワードの存在確認
   - シーケンス図: Mermaidブロック抽出、構文チェック（participant, autonumber, Note）
     - **注**: あくまでMermaid構文の妥当性のみ。実装との整合性は別コマンド
   - **メンテナンス性**:
     - **同じ数値が複数箇所に出現していないか**（例: 「5分」「300秒」が複数箇所に記載）
     - **設計書に実装コード全文（30行以上）が含まれていないか**
     - コードブロックは関数シグネチャと処理概要のみにとどめているか
   - **図表の活用**:
     - Mermaidブロック数、テーブル数をカウント
     - 文章量と図表のバランスを評価
   - **対象読者と目的**:
     - ドキュメント冒頭（最初の50行）に「対象読者」「目的」が明記されているかチェック
     - **不記載の場合は減点対象**（スコアを減点し、改善が必要な点として記載）
   - **目次**:
     - 500行以上の場合、目次（`## 目次`または`## Table of Contents`）の存在確認
   - **API設計**:
     - APIエンドポイントの記載がある場合、リクエスト/レスポンス例の有無チェック
   - **セキュリティ考慮事項**:
     - 「セキュリティ」「認証」「認可」キーワードの存在確認

4. **プロジェクトルール準拠チェック**:
   - `CLAUDE.md`:
     - docs/ 配下の設計書が適切に配置されているか
     - 日本語で記述されているか
   - ドキュメント内のコード例（該当する場合）:
     - `.claude/rules/typescript.md`: import順序の規約準拠
     - `.claude/rules/backend.md`: 日本語コメントの有無

   **注**: 実装コードとの整合性チェックは対象外（別コマンドで実装予定）

### Phase 5: 結果出力

**出力フォーマット**:

````markdown
## レビュー結果: <ドキュメント名>

### ドキュメント情報

- **ファイルパス**: `docs/backend-design.md`
- **ドキュメント種別**: 設計書 (DESIGN)
- **最終更新**: 2025-01-15

---

### 総合評価

| 観点                     | 評価                 | スコア     |
| ------------------------ | -------------------- | ---------- |
| 完全性                   | 良好                 | 3/3 ⭐⭐⭐ |
| 明確性                   | 改善推奨             | 2/3 ⭐⭐   |
| 一貫性                   | 良好                 | 3/3 ⭐⭐⭐ |
| 構造                     | 良好                 | 3/3 ⭐⭐⭐ |
| 実装可能性               | 良好                 | 3/3 ⭐⭐⭐ |
| わかりやすさ             | 良好                 | 3/3 ⭐⭐⭐ |
| メンテナンス性           | 改善推奨             | 1/3 ⭐     |
| 図表の活用               | 優秀                 | 3/3 ⭐⭐⭐ |
| **対象読者と目的**       | ❌ 記載なし          | 0/3        |
| **目次**                 | ✅ 記載あり（776行） | -          |
| **設計の理由・背景**     | ✅ 記載あり          | -          |
| **API設計**              | ✅ 具体的            | -          |
| **セキュリティ考慮事項** | ✅ 記載あり          | -          |
| シーケンス図の妥当性     | 良好                 | 3/3 ⭐⭐⭐ |

**総合スコア**: 20/27 (74%)

---

### 良い点

- ✅ OIDC認可コードフローのシーケンス図が詳細で、autonumberとNoteを活用している
- ✅ セキュリティパラメータの役割と防ぐ攻撃が表形式で明示されている
- ✅ 技術選定の理由が比較表で説明されており、なぜopenid-clientを選んだかが明確
- ✅ 対象読者と目的が冒頭で明記されている
- ✅ API設計でリクエスト/レスポンス例が具体的に記載されている
- ✅ セキュリティ考慮事項が独立したセクションで詳述されている

---

### 改善が必要な点

#### [必須] 重大な問題

- 🚨 **対象読者と目的が不記載**: ドキュメント冒頭に対象読者と目的が明記されていません
  - 理由: ドキュメントの想定読者が不明確だと、適切な粒度で書けているか判断できません
  - 改善案: ドキュメント冒頭に以下のようなセクションを追加してください

    ```markdown
    ## 対象読者

    - OIDCの基礎知識を持つバックエンドエンジニア
    - AWS Lambda、DynamoDBの基本的な使用経験がある方

    ## 目的

    - OIDC認可コードフローのバックエンド実装を理解する
    - セキュリティ考慮事項を含めた実装方針を把握する
    ```

#### [推奨] 改善推奨

- 📝 **メンテナンス性（同じ値の複数箇所記載）**: 「TTLは5分」「300秒」などが複数箇所に出現
  - 理由: 値を変更する際に修正漏れが発生しやすく、ドキュメントの一貫性が損なわれます
  - 改善案: 冒頭で「セッションTTL = 5分（300秒）」と1箇所で定義し、他の箇所では「セッションTTL」と参照する形式にしてください

- 📝 **メンテナンス性（実装コード全文の記載）**: `session.ts` の実装コード全文（50行以上）が設計書に含まれている
  - 理由: 設計書に実装の詳細を載せると、コードが変更されるたびにドキュメントも更新が必要になり、メンテナンス負荷が高くなります
  - 改善案: 設計書では主要な関数のシグネチャと処理概要のみ記載し、詳細な実装は実際のコードファイルに委ねてください

- 📝 **曖昧な表現**: 「適宜リトライする」などの表現を具体化
  - 改善案: 「3回までリトライし、それでも失敗した場合はエラーを返す」のように具体的な条件を明記

#### [提案] さらなる改善

- 💡 **用語の定義**: 初出の専門用語（JWK、JWKS）に簡単な説明を追加すると、より幅広い読者が理解しやすくなります

---

### プロジェクトルールへの準拠

✅ **CLAUDE.md**: docs/ 配下に適切に配置、日本語で記述
✅ **ドキュメント内のコード例**: 日本語コメント含む、import順序は適切

**注**: 実装コードとの整合性チェックは別コマンドで行います

---

### 次のステップ

#### 優先度: 高

1. **対象読者と目的を追加**: ドキュメント冒頭に対象読者と目的のセクションを追加してください

#### 優先度: 中

2. **メンテナンス性の改善**: 同じ値（TTL等）の複数箇所記載を1箇所定義+参照形式に変更
3. **実装コードの削減**: `session.ts` 全文を削除し、関数シグネチャと処理概要のみに簡素化
4. **曖昧な表現の具体化**: 「適宜リトライする」などの表現を具体的な条件に置き換える

#### 優先度: 低

5. **用語の定義追加**: 初出の専門用語（JWK、JWKS）に簡単な説明を追加

---

### レビュー完了

総合的に高品質なドキュメントです。
````

---

## エラーハンドリング

| エラーケース         | 対応                                    |
| -------------------- | --------------------------------------- |
| ファイルが存在しない | エラーメッセージ表示して終了            |
| ファイルが空         | 「ドキュメントが空です」と表示して終了  |
| Globで0件            | 「ドキュメントが見つかりません」と表示  |
| 無効な入力           | 再入力を促す（最大3回）                 |
| git リポジトリでない | git履歴の取得をスキップ、レビューは続行 |

---

## 拡張性の設計

### 新しいドキュメント種別の追加

エージェント定義内のドキュメント種別テーブルに1行追加するだけで対応可能：

```markdown
| TEST_SPEC | ファイル名: `*-test.md`<br>セクション: テストケース | `docs/tests/*.md` |
```

### プロジェクト固有チェックの追加

エージェント定義の「Phase 4 - プロジェクトルール準拠チェック」セクションにチェック項目を追加：

```markdown
#### OIDC関連ドキュメント

- State/Nonce/PKCEのセキュリティパラメータが説明されているか
- シーケンス図に検証ステップが含まれているか
```

---

## 検証方法（実装後のテスト）

### 1. 基本動作確認

```bash
/doc-reviewer
```

1. `docs/**/*.md` が正しく検出されるか
2. ファイル選択UIが表示されるか
3. 番号入力で正しいファイルが選択されるか

### 2. ドキュメント種類判定の確認

以下のファイルで判定が正しいか確認：

| ファイル                          | 期待される種別 |
| --------------------------------- | -------------- |
| `docs/requirements.md`            | PRD            |
| `docs/backend-design.md`          | DESIGN         |
| `docs/infrastructure-design.md`   | ARCHITECTURE   |
| `docs/issues/7-login-endpoint.md` | ISSUE_SPEC     |
| `CLAUDE.md`                       | GUIDE          |

### 3. レビュー観点の確認

`docs/backend-design.md` をレビューして以下を確認：

- ✅ **わかりやすさ**: 対象読者の前提知識への配慮が評価されるか
- ✅ **設計の理由・背景**: 「記載あり」と判定されるか
- ✅ **シーケンス図の妥当性**: チェックが実行されるか
- ✅ **技術選定の根拠**: openid-client vs jose の比較が良い点として挙げられるか
- ✅ **対象読者と目的**: 不記載の場合に減点され、[必須]改善点として指摘されるか
- ✅ **メンテナンス性（同じ値の複数箇所記載）**: 「5分」「300秒」の複数箇所出現が減点され、[推奨]改善点として指摘されるか
- ✅ **メンテナンス性（実装コード全文）**: `session.ts` 全文記載が減点され、[推奨]改善点として指摘されるか
- ✅ **プロジェクトルール準拠**: チェックが実行されるか

### 4. エッジケースのテスト

- 空のファイルを選択 → エラーメッセージ表示
- 無効な番号を入力 → 再入力を促す
- 存在しないパスを入力 → エラーメッセージ表示

---

## 実装時の注意事項

### 1. エージェント定義の記述方法

- **Phase別に明確に分割**: Phase 1, Phase 2... と番号を付ける
- **アルゴリズムは具体的に**: 疑似コードや判定ルールのテーブルを記載
- **出力フォーマットを詳細に**: エージェントが出力すべき形式を例示

### 2. スキル定義のユーザビリティ

- **処理内容は3〜5個のセクション**に分割（多すぎると読みづらい）
- **使用方法は簡潔に**: `/doc-reviewer` の1行だけで実行できることを明示
- **レビュー観点は表形式**で見やすく整理

### 3. 既存パターンへの準拠

| 項目                 | パターン                                  |
| -------------------- | ----------------------------------------- |
| フロントマターの書式 | YAML形式、`name:`, `description:` 必須    |
| エージェントのtools  | `Read, Grep, Glob, Bash` （カンマ区切り） |
| エージェントのmodel  | `sonnet`（複雑な分析タスクのため）        |
| Phase構造            | Phase 1〜5 の見出しレベルを統一           |

### 4. シーケンス図チェックの実装

Mermaidブロックを抽出する方法：

````
1. コンテンツから ```mermaid ... ``` ブロックを検出
2. sequenceDiagram を含むブロックのみ抽出
3. 各ブロック内で以下をチェック:
   - participant の存在
   - ->> (メッセージフロー) の存在
   - autonumber の使用（推奨）
   - Note の使用（推奨）
````

---

## Critical Files（実装対象）

実装で作成・編集するファイル：

### 新規作成

1. **`.claude/skills/doc-reviewer/SKILL.md`** (約100〜150行)
   - ユーザー向けスキル定義
   - 処理内容、使用方法、レビュー観点の説明

2. **`.claude/agents/doc-reviewer-agent/doc-reviewer-agent.md`** (約500〜700行)
   - エージェント詳細定義
   - Phase 1〜5の実行フロー、アルゴリズム、出力フォーマット

### 参考ファイル（実装時に参照）

- `.claude/skills/git-commit/SKILL.md` - スキル定義の書き方
- `.claude/agents/git-commit-agent/git-commit-agent.md` - エージェント定義の書き方
- `docs/backend-design.md` - 良質な設計書の例、レビュー対象のサンプル

---

## 実装手順

1. **ディレクトリ作成**:

   ```bash
   mkdir -p .claude/skills/doc-reviewer
   mkdir -p .claude/agents/doc-reviewer-agent
   ```

2. **スキル定義の作成**:
   - `.claude/skills/doc-reviewer/SKILL.md` を作成
   - フロントマター、概要、処理内容、使用方法を記載

3. **エージェント定義の作成**:
   - `.claude/agents/doc-reviewer-agent/doc-reviewer-agent.md` を作成
   - Phase 1〜5の詳細フローを記載
   - ドキュメント種類判定ロジック、レビュー観点、出力フォーマットを定義

4. **動作確認**:
   - `/doc-reviewer` を実行
   - `docs/backend-design.md` をレビューして期待通りの結果が得られるか確認

---

## 期待される成果物

### ユーザー体験

1. `/doc-reviewer` を実行
2. ドキュメント一覧から番号で選択
3. 数秒後に詳細なレビューレポートが表示される
4. 改善点が明確で、次のアクションがわかる

### レビュー品質

- **対象読者と目的の不記載を検出**し、[必須]改善点として指摘できる
- **設計の理由・背景の記載漏れ**を検出できる
- **シーケンス図の基本的な問題**を検出できる
- **メンテナンス性の問題**を検出できる
  - 同じ数値（TTL等）の複数箇所記載
  - 設計書への実装コード全文記載
- **わかりやすさの問題**を検出できる（対象読者の前提知識への配慮）
- **プロジェクト固有ルール**（CLAUDE.md、.claude/rules/）への準拠をチェックできる
- **曖昧な表現、表記揺れ、専門用語の定義不足**を検出できる

### 拡張性

- 新しいドキュメント種別を簡単に追加できる
- プロジェクト固有のチェック項目を追加できる
- 他のプロジェクトでも再利用可能（汎用的な設計）
