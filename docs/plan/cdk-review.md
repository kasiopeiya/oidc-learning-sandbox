# CDK専用コードレビューコマンド `/cdk-review` 実装計画

## Context

### なぜこの変更が必要か

現在、`/review` コマンドは Backend と Frontend の TypeScript コードのレビューに対応していますが、CDKコード（`cdk/**/*.ts`）は明示的に除外されています。CDKコードには Infrastructure as Code 特有のベストプラクティス（L2 Construct の優先利用、宣言的記述、スタック分割の適切さなど）があり、これらを専門的にチェックするコマンドが必要です。

### 解決したい課題

1. **CDK特有のベストプラクティスをチェックできない**: 既存の `/review` は汎用的なTypeScriptレビューであり、CDK特有の観点（L2 Construct、Import形式、IAM自動生成など）を網羅していない
2. **プロジェクトルール（`.claude/rules/cdk.md`）の準拠度を自動チェックしたい**: 手動レビューでは見落としが発生しやすい
3. **仕様駆動開発フローの Step 6.2 をサポート**: `/cdk-dev` でインフラ実装した後のコードレビュー工程を自動化

---

## 実装アプローチ

### 基本方針

既存の `/review` スキルの優れた設計パターン（スキルとエージェントの分離、5つのPhase、出力フォーマット）を完全に踏襲しつつ、**CDK特有の17項目のレビュー観点**を追加します。

---

## レビュー観点（17項目、51点満点）

### TypeScript共通観点（8項目、24点満点）

| #   | 観点               | チェック内容                                       | スコアリング基準                                    | 検出方法               |
| --- | ------------------ | -------------------------------------------------- | --------------------------------------------------- | ---------------------- |
| 1   | 型安全性           | `any`の使用、型アサーション                        | 3点: `any`なし / 2点: 一部 / 1点: 多数              | Grep: `\bany\b`        |
| 2   | 命名規則           | 変数名、関数名、**Construct ID（パスカルケース）** | 3点: 一貫性あり / 2点: 一部不明瞭 / 1点: 不適切多数 | Read + パターン分析    |
| 3   | 単一責任           | Constructの責務の明確性                            | 3点: 単一責任 / 2点: やや複数 / 1点: 明らかに複数   | Read結果を分析         |
| 4   | 重複コード         | DRY原則の遵守                                      | 3点: 重複なし / 2点: 軽微 / 1点: 顕著               | Read結果を分析         |
| 5   | コメント           | WHYコメント（日本語）の存在と適切性                | 3点: 適切 / 2点: 一部不足 / 1点: なしor過多         | Grep: 日本語文字       |
| 6   | エラーハンドリング | 適切なエラー処理                                   | 3点: 適切 / 2点: 一部不足 / 1点: なし               | Read結果を分析         |
| 7   | セキュリティ       | ハードコード、環境変数の扱い                       | 3点: リスクなし / 2点: 軽微 / 1点: 重大             | Grep: 秘密情報パターン |
| 8   | Import順序         | CDKルールに準拠（標準→CDK→自作）                   | 3点: 正しい / 2点: 一部違反 / 1点: 違反多数         | Read結果を分析         |

### CDK固有観点（9項目、27点満点）

| #   | 観点                 | チェック内容                             | スコアリング基準                                    | 検出方法                        |
| --- | -------------------- | ---------------------------------------- | --------------------------------------------------- | ------------------------------- | --- | ---------------------- |
| 9   | 宣言的記述           | ifなどの制御構文の多用を避ける           | 3点: 宣言的 / 2点: 一部手続き的 / 1点: 手続き的多数 | Grep: `\b(if                    | for | while)\s\*\(` カウント |
| 10  | L2 Construct優先     | L2優先、L1使用時は理由記載               | 3点: L2優先 / 2点: L1あり理由なし / 1点: L1多用     | Grep: `Cfn[A-Z]` + コメント確認 |
| 11  | Import形式統一       | `aws_* as service` 形式                  | 3点: 統一 / 2点: 一部違反 / 1点: 未統一             | Grep: `from 'aws-cdk-lib/aws-`  |
| 12  | IAM自動生成活用      | grant\*メソッド活用、明示的Role避ける    | 3点: grant活用 / 2点: 一部明示的 / 1点: 明示的多数  | Grep: `grant`, `new iam.Role`   |
| 13  | リソース名自動生成   | 不必要にリソース名を指定しない           | 3点: 自動生成活用 / 2点: 一部指定 / 1点: 指定多数   | Grep: `Name:` プロパティ        |
| 14  | RemovalPolicy明示    | Statefulリソースに適切に設定             | 3点: 適切 / 2点: 一部未設定 / 1点: 未設定多数       | Grep: `RemovalPolicy`           |
| 15  | Construct ID規則     | メインリソースIDが`Resource`/`Default`   | 3点: 規則遵守 / 2点: 一部違反 / 1点: 規則無視       | Read + Construct内ID確認        |
| 16  | スタック分割の適切さ | デプロイ単位として適切に分割されているか | 3点: 適切 / 2点: 分割余地あり / 1点: 明らかに不適切 | Read + ADR確認                  |
| 17  | 循環参照の検出       | リソース間の依存関係に循環がないか       | 3点: 循環なし / 2点: 潜在的リスク / 1点: 循環あり   | Read + 依存関係分析             |

**重要な設計決定:**

- **cdk synth は実行しない**: レビューを高速化するため、コード分析のみで循環参照を検出
- **スタック分割の観点を追加**: ステートフルリソース専用スタック、デプロイの観点での分割理由、ADRとの整合性をチェック
- **Construct IDパスカルケースは「命名規則」観点に統合**: 項目数を15→17に調整（元の計画から+2）

---

## 実行フロー（Phase 1〜5）

### Phase 1: ファイル検出とインタラクティブ選択

**ステップ 1-1: レビュー対象ファイルの検出**

```
Glob pattern: "**/*.ts"
path: "cdk"
```

**除外パターン**（検出後にフィルタリング）:

- `node_modules/` を含むパス
- テストファイル: `**/*.test.ts`, `**/*.spec.ts`
- 設定ファイル: `*.config.ts`, `vitest.config.ts`

**ステップ 1-2: ファイルの種別分類**

| 種別          | パスパターン              | 説明                        |
| ------------- | ------------------------- | --------------------------- |
| **App**       | `cdk/bin/*.ts`            | CDKアプリエントリーポイント |
| **Stack**     | `cdk/lib/*-stack.ts`      | スタック定義                |
| **Construct** | `cdk/lib/constructs/*.ts` | カスタムConstruct（L3）     |
| **Parameter** | `cdk/parameter.ts`        | 環境設定                    |

**ステップ 1-3: ファイル一覧の表示**

```
=== CDK レビュー対象ファイル一覧 ===

【App】
1. cdk/bin/app.ts

【Stack】
2. cdk/lib/oidc-sandbox-stack.ts

【Parameter】
3. cdk/parameter.ts

選択してください:
- 番号（例: 2）
- ファイルパス（例: cdk/lib/oidc-sandbox-stack.ts）
- キャンセルする場合は空Enter
```

**ステップ 1-4: AskUserQuestion でユーザー入力を受付**

### Phase 2: コード種別の判定

選択されたファイルパスから種別を判定:

| パスパターン              | 種別      | 特別な考慮事項                                   |
| ------------------------- | --------- | ------------------------------------------------ |
| `cdk/bin/*.ts`            | App       | エントリーポイント、Stackインスタンス化のみ      |
| `cdk/lib/*-stack.ts`      | Stack     | リソース定義、循環参照対策、スタック分割の適切さ |
| `cdk/lib/constructs/*.ts` | Construct | 再利用性、カプセル化、ID規則（Resource/Default） |
| `cdk/parameter.ts`        | Parameter | 型安全性、環境別設定                             |

### Phase 3: レビュー観点の定義

17項目の観点を定義（上記「レビュー観点」セクション参照）

### Phase 4: レビュー実行

**ステップ 4-1: ファイル内容の取得**

```
Read: <選択されたファイルのパス>
```

**ステップ 4-2: 変更履歴の確認**

```
Bash: git log -1 --pretty=format:"%h - %an, %ar : %s" -- <ファイルパス>
```

**ステップ 4-3: 各観点のチェック**

##### TypeScript共通観点のチェック（観点1〜8）

1. **型安全性**: `Grep pattern: "\bany\b"`
2. **命名規則**: Read結果からConstruct ID、変数名を分析、パスカルケースチェック
3. **単一責任**: Read結果からConstructの責務を分析
4. **重複コード**: Read結果から重複パターンを検出
5. **コメント**: `Grep pattern: "[ぁ-んァ-ヶー一-龠]"` で日本語コメント検出
6. **エラーハンドリング**: Read結果からtry-catch、エラー処理を分析
7. **セキュリティ**: `Grep pattern: "(password|secret|key|token)\s*[:=]\s*['\"]"` でハードコード検出
8. **Import順序**: Read結果から先頭のimport文を抽出、順序をチェック

##### CDK固有観点のチェック（観点9〜17）

9. **宣言的記述**: `Grep pattern: "\b(if|for|while)\s*\("` で制御構文の出現回数をカウント
10. **L2 Construct優先**: `Grep pattern: "Cfn[A-Z]"` でL1使用を検出、周辺のコメントで理由を確認
11. **Import形式統一**: `Grep pattern: "from\s+['\"]aws-cdk-lib/aws-"` で非推奨形式を検出
12. **IAM自動生成**: `Grep pattern: "grant[A-Z]"` と `new iam.Role` の使用バランスをチェック
13. **リソース名自動生成**: `Grep pattern: "(bucketName|functionName|tableName|queueName):"` で明示的指定を検出
14. **RemovalPolicy**: `Grep pattern: "RemovalPolicy"` で設定箇所をチェック
15. **Construct ID規則**: Read結果から自作Construct内のメインリソースIDを確認
16. **スタック分割の適切さ**:
    - Read結果からスタック内のリソース数とStateful/Statelessリソースの分布を分析
    - `docs/design/adr/` 配下のスタック分割ADRを検索（存在する場合）
    - ADRの方針とコードの整合性をチェック
17. **循環参照の検出**:
    - Read結果からリソース間の依存関係（`grantXxx`, `addToResourcePolicy`, `.node.defaultChild` 等）を抽出
    - 依存関係グラフを構築し、循環を検出

**ステップ 4-4: CDKリソース数のカウント**

以下のリソース数をカウント:

- Construct定義数（クラス定義のカウント）
- Lambda関数数（`aws_lambda.Function`, `aws_lambda_nodejs.NodejsFunction`）
- S3バケット数（`aws_s3.Bucket`）
- DynamoDBテーブル数（`aws_dynamodb.Table`）
- その他主要リソース

**ステップ 4-5: 依存関係グラフの生成**

- **基本**: メインリソース（Lambda, S3, Cognito, DynamoDB等）のみ
- **循環参照検出時**: そのリソースも含める
- **出力形式**: テキストベースの簡易グラフ（Mermaid記法等）

**ステップ 4-6: スコアリング**

各観点を3点満点で評価:

- **総合スコア**: 51点満点（17項目 × 3点）
- **レベル判定**:
  - 48点以上: 優秀（Excellent）
  - 41-47点: 良好（Good）
  - 34-40点: 要改善（Needs Improvement）
  - 34点未満: 要リファクタリング（Needs Refactoring）

### Phase 5: 結果出力

出力フォーマット:

```markdown
## CDK Code Review Report

### 📁 ファイル情報

- **ファイル**: `<ファイルパス>`
- **種別**: <App/Stack/Construct/Parameter>
- **最終更新**: <git log による最終コミット情報>

### 📊 総合評価

- **スコア**: X / 51点
- **レベル**: <優秀/良好/要改善/要リファクタリング>

### 📦 CDKリソース情報

- **Construct定義数**: X個
- **Lambda関数数**: X個
- **S3バケット数**: X個
- **DynamoDBテーブル数**: X個
- **その他主要リソース**: X個

---

### ✅ 良い点（最低3つ）

1. **<観点名>**: <具体的な良い点の説明>
2. **<観点名>**: <具体的な良い点の説明>
3. **<観点名>**: <具体的な良い点の説明>

---

### 🔧 改善が必要な点

#### 🚨 必須（Critical）

<セキュリティリスク、型安全性の重大な問題など、1点の項目>

- **<観点名>**: <具体的な問題の説明>
  - **場所**: `<ファイルパス>:<行番号>`
  - **現状**: <現在のコード例>
  - **提案**: <改善後のコード例>
  - **理由**: <なぜこの改善が必要か>

#### ⚠️ 推奨（Recommended）

<設計原則違反、保守性の問題など、2点の項目>

- **<観点名>**: <具体的な問題の説明>
  - **場所**: `<ファイルパス>:<行番号>`
  - **現状**: <現在のコード例>
  - **提案**: <改善後のコード例>
  - **理由**: <なぜこの改善が必要か>

#### 💡 提案（Suggested）

<命名、コメント、スタイル改善など、3点だが改善余地がある項目>

- **<観点名>**: <具体的な提案の説明>
  - **場所**: `<ファイルパス>:<行番号>`
  - **現状**: <現在のコード例>
  - **提案**: <改善後のコード例>
  - **理由**: <なぜこの改善が良いか>

---

### 📏 CDKルールへの準拠

- **✅ / ⚠️ / ❌ L2 Construct優先**: <準拠状況の詳細>
- **✅ / ⚠️ / ❌ Import形式統一**: <準拠状況の詳細>
- **✅ / ⚠️ / ❌ IAM自動生成活用**: <準拠状況の詳細>
- **✅ / ⚠️ / ❌ 日本語コメント**: <準拠状況の詳細>
- **✅ / ⚠️ / ❌ RemovalPolicy設定**: <準拠状況の詳細>

---

### 🔗 依存関係グラフ

**メインリソース間の依存関係:**
```

<Mermaid形式等の簡易グラフ>

```

**循環参照チェック結果:**
- ✅ 循環参照なし
- ⚠️ 潜在的な循環参照リスク: <詳細>
- ❌ 循環参照検出: <詳細>

---

### 🚀 次のステップ（優先度付き）

1. **<最優先で修正すべき項目>**
   - <具体的なアクション>

2. **<次に修正すべき項目>**
   - <具体的なアクション>

3. **<時間があれば改善したい項目>**
   - <具体的なアクション>

---

**レビュー完了**
```

---

## ファイル構成

### 作成するファイル

#### 1. スキルファイル

**ファイルパス**: `.claude/skills/cdk-review/SKILL.md`

**内容**:

- コマンド説明
- 処理内容（Phase 1〜5の概要）
- 17項目のレビュー観点のリスト
- 使用方法
- レビュー対象の制限（テストコード、node_modules除外）
- エージェント起動指示

#### 2. エージェントファイル

**ファイルパス**: `.claude/agents/cdk-reviewer-agent/cdk-reviewer-agent.md`

**内容**:

- 詳細な実行プロセス（Phase 1〜5）
- 各Phaseのステップバイステップ手順
- 17項目のレビュー観点とスコアリング基準の詳細
- 各観点の検出方法（Grep, Read, Bash）
- 出力フォーマットの詳細定義
- エラーハンドリング
- レビューの姿勢（建設的、具体的、バランス、実用的、根拠）

---

## Critical Files

### 参考にするファイル

- [review/SKILL.md](file:///Users/yutohasegawa/dev/oidc-learning-sandbox/.claude/skills/review/SKILL.md) - 既存の `/review` スキルの構造パターン
- [code-reviewer-agent.md](file:///Users/yutohasegawa/dev/oidc-learning-sandbox/.claude/agents/code-reviewer-agent/code-reviewer-agent.md) - 既存エージェントの詳細な実行プロセス
- [cdk.md](file:///Users/yutohasegawa/dev/oidc-learning-sandbox/.claude/rules/cdk.md) - CDKルール（レビュー観点に反映）
- [infrastructure-design.md](file:///Users/yutohasegawa/dev/oidc-learning-sandbox/docs/design/infrastructure-design.md) - CDK設計思想（スタック分割の観点に活用）

### レビュー対象の実装例

- [oidc-sandbox-stack.ts](file:///Users/yutohasegawa/dev/oidc-learning-sandbox/cdk/lib/oidc-sandbox-stack.ts) - 既存のスタック実装（レビュー観点の検証）

---

## Verification（検証方法）

### 1. スキルとエージェントの作成

- `.claude/skills/cdk-review/SKILL.md` を作成
- `.claude/agents/cdk-reviewer-agent/cdk-reviewer-agent.md` を作成

### 2. 動作確認

```bash
# スキルを実行
/cdk-review
```

**期待される動作**:

1. ファイル一覧が表示される（App/Stack/Parameter種別ごと）
2. ファイルを選択できる（番号またはパス入力）
3. レビューレポートが生成される（17項目、51点満点）
4. 良い点3つ以上、改善点（Critical/Recommended/Suggested）、CDKルール準拠状況、依存関係グラフ、次のステップが含まれる

### 3. レビュー品質の確認

既存のスタックファイル（`cdk/lib/oidc-sandbox-stack.ts`）をレビューして、以下をチェック:

- [ ] L2 Construct使用を評価できているか
- [ ] Import形式（`aws_* as service`）を検出できているか
- [ ] 日本語コメントの充実度を評価できているか
- [ ] スタック分割の適切さをADRと照らし合わせて評価できているか
- [ ] 循環参照の検出ができているか（依存関係グラフ生成）
- [ ] CDKリソース数をカウントできているか
- [ ] 具体的な改善コード例が提示されているか

### 4. エラーハンドリングの確認

- [ ] 存在しないファイルを選択した場合のエラーメッセージ
- [ ] 空ファイルの場合のエラーメッセージ
- [ ] キャンセル時の正常終了

---

## 実装の優先度

### Phase 1: 最小実装（MVP）

1. スキルファイル作成
2. エージェントファイル作成
3. ファイル検出と選択機能（Phase 1）
4. TypeScript共通観点8項目のチェック実装（Phase 3-4）
5. 基本的な出力フォーマット実装（Phase 5）

### Phase 2: CDK固有観点追加

6. CDK固有観点9項目のチェック実装（Phase 3-4）
7. CDKリソース数カウント追加（Phase 4-4）
8. 依存関係グラフ生成追加（Phase 4-5）
9. CDKルール準拠セクション追加（Phase 5）

### Phase 3: 精度向上

10. スコアリング基準の調整
11. 出力フォーマットの改善（具体的なコード例の充実）
12. エラーハンドリングの強化

---

## 既存スキルとの違い

| スキル               | スコープ                    | 観点数 | スコア   | CDK固有観点 | cdk synth       |
| -------------------- | --------------------------- | ------ | -------- | ----------- | --------------- |
| `/review`            | Backend/Frontend TypeScript | 11項目 | 33点満点 | ❌          | -               |
| `/cdk-review` (新規) | CDK TypeScript              | 17項目 | 51点満点 | ✅ (9項目)  | ❌ (実行しない) |
| `/ci`                | 静的解析+テスト（全体）     | -      | -        | ❌          | -               |
| `/cdk-ci`            | CDK静的解析+テスト+合成     | -      | -        | ❌          | ✅              |

**役割分担**:

- `/cdk-review`: 特定ファイルのコード品質レビュー（17観点、51点満点）
- `/cdk-ci`: プロジェクト全体の自動チェック（ESLint, テスト, cdk synth）

---

## 注意事項

### 既存パターンの踏襲

- `/review` スキルの構造を完全に踏襲
- Phase 1〜5の実行フロー構造を維持
- AskUserQuestion、Glob、Grep、Read、Bash の使用パターンを統一

### CDK特有の配慮

- `cdk/node_modules/` を確実に除外（Globで膨大なファイルが検出される）
- L1 Construct（`Cfn*`）の使用は一律NG扱いせず、コメントで理由が記載されているか確認
- cdk synth は実行しないため、コード分析で循環参照を検出

### スコアリングの客観性

- Grepで検出可能な項目を優先
- 主観的判断が必要な項目は具体的な基準を設ける
- エージェントがコード全体を読み込み、構造を分析してスコアリング

### 出力の実用性

- 単なる指摘ではなく、具体的な改善コード例を提示
- 「なぜこの改善が必要か」を必ず説明
- 優先度（Critical/Recommended/Suggested）を明確化

---

**実装完了後、`/cdk-review` コマンドで既存のスタックファイルをレビューし、17観点すべてが正しく機能することを確認してください。**
