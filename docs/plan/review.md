# `/review` スラッシュコマンド実装計画

## Context（背景と目的）

### なぜこの変更が必要か

現在、Backend と Frontend の TypeScript アプリケーションコードをレビューする統合的なコマンドがありません。開発フロー（CLAUDE.md）の Step 6.1 に `/review` が記載されていますが、未実装の状態です。

コードレビューは以下の観点で重要です：

- **コード品質の維持**: 型安全性、命名規則、関数の長さなどの基本的な品質指標
- **設計原則の遵守**: 単一責任の原則、DRY 原則、適切な抽象化
- **セキュリティリスクの低減**: ハードコード、インジェクション脆弱性の早期発見
- **プロジェクトルールの準拠**: import 順序、日本語コメントなどのプロジェクト固有ルール
- **レビューの一貫性**: 人間によるレビューの前に、機械的にチェックできる項目を自動化

### 解決したい問題

1. **手動レビューの負担**: コード品質チェックを手動で行うと時間がかかり、見落としが発生する
2. **レビュー観点の不統一**: レビュアーによってチェック項目が異なる
3. **TDD サイクル後の品質チェックがない**: `/tdd` でコードを実装した後、品質チェックのステップがない
4. **プロジェクトルールの形骸化**: `.claude/rules/` に記載されたルールが実装時に守られているか確認する手段がない

### 期待される成果

- `/review` コマンド一つで、TypeScript コードの詳細なレビューを実行
- 型安全性、設計原則、セキュリティ、プロジェクトルール準拠を自動チェック
- 改善提案を「必須/推奨/提案」の3段階で分類し、優先度を明確化
- `/doc-reviewer` と同様の詳細なレポート形式で、建設的なフィードバックを提供

---

## 実装方針

### 既存スキルとの関係

| スキル               | スコープ                 | 実行タイミング                  |
| -------------------- | ------------------------ | ------------------------------- |
| `/tdd`               | テスト駆動でコード実装   | Step 6.1 (アプリケーション実装) |
| **`/review`** (新規) | **コード品質レビュー**   | **Step 6.1 (実装後)**           |
| `/validate-design`   | 設計書との整合性チェック | Step 6.1 (実装後)               |
| `/unit-test`         | 単体テスト実行のみ       | 開発中                          |

### 参考にする既存実装

- **`/doc-reviewer`**: スキル・エージェント構造、インタラクティブファイル選択、詳細レポート形式
- **`/ci`**: 段階的なチェックと早期失敗、エラー時の修正提案

### 設計判断

#### レビュー対象の範囲

**✅ レビュー対象**:

- `backend/src/**/*.ts` （Lambda handlers, utils）
- `frontend/src/**/*.ts`, `frontend/src/**/*.tsx` （pages, contexts, utils）

**❌ 対象外**:

- `cdk/**/*` - インフラコードは別の観点が必要（ユーザー要望）
- `**/*.test.ts`, `**/*.test.tsx` - テストコードは別の観点が必要
- `node_modules/`, `dist/`, `build/` - ビルド成果物

#### レビュー観点の選定

**共通観点**（Backend/Frontend 共通）:

- 型安全性（`any` 使用、型アサーション乱用）
- 命名規則（変数名・関数名・クラス名の明確性）
- 関数の長さ（1関数50行以内を推奨）
- 重複コード（DRY 原則違反）
- 単一責任（1関数/クラスが1つの責任）
- 引数の数（3個以下を推奨）
- マジックナンバー（ハードコード数値・文字列）
- コメントの適切性（JSDoc 記載、Why 中心、無駄な説明なし）
- エラーハンドリング（try-catch 適切性、エラーメッセージ）
- セキュリティ（インジェクション、秘密情報ハードコード）
- 非同期処理（async/await 適切性、並列化検討）

**プロジェクトルール準拠**:

- TypeScript 共通: import 順序（標準→サードパーティ→自作）
- Backend: 処理ステップに日本語コメント
- Frontend: 処理ステップに日本語コメント

#### モデル選択

- **エージェントモデル**: `opus` （複雑なコードレビューには高性能モデルが必要）

---

## 実装内容

### Phase 1: スキル定義ファイルの作成

**作成するファイル**: `.claude/skills/review/SKILL.md`

以下の構成で実装：

```markdown
---
name: review
description: Review TypeScript application code for backend and frontend with detailed code quality analysis
---

# Code Review Command

Backend と Frontend の TypeScript アプリケーションコードをレビューし、詳細なフィードバックを提供するスキルです。

このスキルは、`code-reviewer-agent` サブエージェントを呼び出します。

## 処理内容

### 1. レビュー対象ファイルの検出と選択

- `backend/src/`, `frontend/src/` 配下の `.ts`, `.tsx` ファイルを検出
- **除外**: `cdk/**/*`, `**/*.test.ts`, `**/*.test.tsx`
- インタラクティブにファイルを選択（番号またはパス指定）

### 2. コード種別の自動判定

- Backend Handler (handlers/\*.ts)
- Backend Utility (utils/\*.ts)
- Frontend Page (pages/\*.tsx)
- Frontend Context (contexts/\*.tsx)
- Frontend Utility (utils/\*.ts)

### 3. レビュー観点に基づく評価

#### 共通観点

- 型安全性、命名規則、関数の長さ、重複コード
- 単一責任、引数の数、マジックナンバー
- コメントの適切性（JSDoc、Why 中心、無駄な説明なし）
- エラーハンドリング、非同期処理、セキュリティ

#### プロジェクトルール準拠

- import 順序（.claude/rules/typescript.md）
- 日本語コメント（.claude/rules/backend.md, .claude/rules/frontend.md）

### 4. 詳細レポート生成

- 総合評価とスコア（3点満点制）
- 良い点（最低3つ）
- 改善が必要な点（必須/推奨/提案の3段階）
- プロジェクトルールへの準拠状況
- 次のステップ（優先度付き）

## レビューの姿勢

- **建設的**: 批判ではなく、改善のための提案
- **具体的**: 「どこが」「なぜ」「どう改善するか」を明示
- **バランス**: 悪い点だけでなく、良い点も必ず指摘（最低3つ）
- **実用的**: 実際に実行可能な改善案を提示
- **根拠**: 改善提案には必ず理由を添える

## スコープ

**アプリケーションコードのみをレビュー**：

- ✅ Backend/Frontend の TypeScript コードをレビュー
- ❌ CDK コード（`cdk/**/*`）は対象外
- ❌ テストコード（`**/*.test.ts`）は対象外
- ❌ 設計書との整合性チェックは対象外（`/validate-design` で実行）

## 使用方法

\`\`\`bash
/review
\`\`\`

---

## 実行指示（Claude Code への指示）

このスキルが呼び出されたら、以下を**厳格に**実行すること：

### 1. エージェントの起動

Task ツールを使用して `code-reviewer-agent` サブエージェントを起動：

\`\`\`
subagent_type: "code-reviewer-agent"
prompt: "TypeScript アプリケーションコードをレビューしてください"
\`\`\`

### 2. 出力の表示

エージェントが完了したら、**その出力をそのまま全文表示する**こと。

**重要**: 以下の行為は**禁止**：

- ❌ エージェントの出力を要約する
- ❌ エージェントの出力を加工する
- ❌ エージェントの出力にコメントを追加する
- ❌ エージェントの出力を解釈して説明する

**許可される行為**:

- ✅ エージェントの出力を全文そのまま表示する
```

---

### Phase 2: エージェント定義ファイルの作成

**作成するファイル**: `.claude/agents/code-reviewer-agent/code-reviewer-agent.md`

以下の構成で実装：

```markdown
---
name: code-reviewer-agent
description: Review TypeScript application code with detailed quality analysis and actionable feedback
tools: Read, Grep, Glob, Bash
model: opus
---

# Code Reviewer Agent

TypeScript アプリケーションコードを詳細にレビューし、品質と保守性に関するフィードバックを提供する専門エージェント。

## スコープ

**アプリケーションコードのみをレビュー**：

- ✅ Backend/Frontend の TypeScript コードをレビュー
- ✅ コード内の品質、設計、セキュリティをチェック
- ❌ CDK コード（`cdk/**/*`）は対象外
- ❌ テストコード（`**/*.test.ts`）は対象外
- ❌ 設計書との整合性チェックは対象外（`/validate-design` で実行）

---

## 実行プロセス

### Phase 1: ファイル検出とインタラクティブ選択

#### ステップ 1-1: アプリケーションファイルの検出

Glob ツールを使用してファイルを列挙：

\`\`\`
pattern: "backend/src/**/\*.ts"
pattern: "frontend/src/**/_.ts_"
\`\`\`

**除外パターン**（Grep で除外）:

- `**/*.test.ts`
- `**/*.test.tsx`
- `**/test/**`

**取得情報**:

- ファイルパス一覧
- ディレクトリ構造（handlers, utils, pages, contexts）

#### ステップ 1-2: ファイル候補の表示

以下の形式でユーザーに候補を提示：

\`\`\`
=== Code Review ===

Found N application files:

📁 Backend Handlers

1. backend/src/handlers/login.ts
2. backend/src/handlers/callback.ts
3. backend/src/handlers/account.ts

📁 Backend Utilities 4. backend/src/utils/cookie.ts 5. backend/src/utils/oidc-config.ts 6. backend/src/utils/pkce.ts
...

📁 Frontend Pages 15. frontend/src/pages/IndexPage.tsx 16. frontend/src/pages/CallbackPage.tsx
...

📁 Frontend Contexts 20. frontend/src/contexts/AuthContext.tsx

📁 Frontend Utilities 21. frontend/src/utils/api.ts

Enter file number to review (1-N), or file path directly:
\`\`\`

#### ステップ 1-3: ユーザー入力の処理

**入力形式**:

- 番号（例: `1`）
- ファイルパス（例: `backend/src/handlers/login.ts`）
- 相対パス（例: `handlers/login.ts`）

**エラーハンドリング**:

- 無効な番号 → 再入力を促す（最大3回）
- ファイルが存在しない → エラーメッセージ表示
- 空入力 → キャンセル

---

### Phase 2: コード種別の判定

#### 判定アルゴリズム

ファイルパスから種別を判定：

| パス                          | 種別             |
| ----------------------------- | ---------------- |
| `backend/src/handlers/*.ts`   | Backend Handler  |
| `backend/src/utils/*.ts`      | Backend Utility  |
| `frontend/src/pages/*.tsx`    | Frontend Page    |
| `frontend/src/contexts/*.tsx` | Frontend Context |
| `frontend/src/utils/*.ts`     | Frontend Utility |
| 上記以外                      | General          |

---

### Phase 3: レビュー観点の選択

#### 3-1 共通観点（全ファイル対象）

| 観点                   | チェック内容                               | スコア  |
| ---------------------- | ------------------------------------------ | ------- |
| **型安全性**           | `any`使用、型アサーション乱用がないか      | 3点満点 |
| **命名規則**           | 変数名・関数名・クラス名が明確か           | 3点満点 |
| **関数の長さ**         | 1関数50行以内か                            | 3点満点 |
| **重複コード**         | DRY原則違反がないか                        | 3点満点 |
| **単一責任**           | 1関数/クラスが1つの責任を持つか            | 3点満点 |
| **引数の数**           | 関数引数3個以下か                          | 3点満点 |
| **マジックナンバー**   | ハードコード数値・文字列がないか           | 3点満点 |
| **コメントの適切性**   | JSDoc記載、Why中心、無駄な説明なし         | 3点満点 |
| **エラーハンドリング** | try-catch適切性、エラーメッセージ有用性    | 3点満点 |
| **セキュリティ**       | インジェクション、秘密情報ハードコードなし | 3点満点 |
| **非同期処理**         | async/await適切性、並列化検討              | 3点満点 |

#### 3-2 プロジェクトルール準拠

| ルール             | チェック内容                           | 参照ファイル                  |
| ------------------ | -------------------------------------- | ----------------------------- |
| **TypeScript共通** | import順序（標準→サードパーティ→自作） | `.claude/rules/typescript.md` |
| **Backend**        | 処理ステップに日本語コメント           | `.claude/rules/backend.md`    |
| **Frontend**       | 処理ステップに日本語コメント           | `.claude/rules/frontend.md`   |

---

### Phase 4: レビュー実行

#### ステップ 4-1: コード内容の読み取り

Read ツールでファイル全体を取得し、以下を記録：

- 総行数
- 関数数
- import 文の数
- コメント行数

#### ステップ 4-2: コンテキスト情報の収集

\`\`\`bash
git log --oneline --follow -5 -- <file_path>
\`\`\`

ファイルの最終更新日と変更履歴を確認。

#### ステップ 4-3: 各観点の評価

##### 型安全性チェック

Grep で以下を検索：

\`\`\`
pattern: "\\bany\\b"
pattern: "as\\s+\\w+" # 型アサーション
pattern: "!\\." # non-null assertion
\`\`\`

**評価基準**:

- `any` 使用なし: 3点
- `any` 使用1-2箇所: 2点（警告レベルで許容される場合）
- `any` 使用3箇所以上: 1点

##### 命名規則チェック

以下を確認：

- 変数名が `camelCase` か
- 関数名が動詞から始まるか（`get`, `set`, `fetch`, `handle` など）
- クラス名が `PascalCase` か
- 定数が `UPPER_SNAKE_CASE` か

##### 関数の長さチェック

各関数の行数を数え、50行を超える関数を検出。

##### マジックナンバーチェック

Grep で数値・文字列リテラルを検索（定数定義されていないもの）：

\`\`\`
pattern: "\\b[0-9]{3,}\\b" # 3桁以上の数値
pattern: "['\"](http|https)://" # URL のハードコード
pattern: "['\"](secret|password|token|key)['\"]:?\\s\*['\"]\w+" # 秘密情報
\`\`\`

##### コメントの適切性チェック

以下を確認：

- 関数に JSDoc コメントがあるか
- コメントが「What」ではなく「Why」を説明しているか
- 無駄な説明コメント（コードを読めばわかる内容）がないか

**悪い例**:
\`\`\`typescript
// ユーザー名を取得
const userName = user.name; // ❌
\`\`\`

**良い例**:
\`\`\`typescript
// Cognito では given_name + family_name の形式で返されるため、
// フルネームとして結合する必要がある
const fullName = \`\${user.given_name} \${user.family_name}\`; // ✅
\`\`\`

##### エラーハンドリングチェック

- `try-catch` ブロックの適切性
- エラーメッセージがデバッグに有用か
- エラーの再スロー（catchして何もしない等）がないか

##### セキュリティチェック

Grep で以下を検索：

\`\`\`
pattern: "process\\.env\\.\\w+\\s\*!" # 環境変数の存在チェックなし
pattern: "eval\\("
pattern: "innerHTML"
pattern: "dangerouslySetInnerHTML"
\`\`\`

##### プロジェクトルール準拠チェック

**TypeScript 共通: import 順序**

Read で import 文を抽出し、以下の順序になっているか確認：

1. 標準ライブラリ（`fs`, `path`, `crypto` など）
2. サードパーティライブラリ（`aws-lambda`, `react` など）
3. 自作モジュール（相対パス `./`, `../`）

**Backend/Frontend: 日本語コメント**

処理ステップに日本語コメントがあるかを確認。

---

### Phase 5: 結果出力

#### 出力フォーマット

\`\`\`markdown

## コードレビュー結果: <ファイル名>

### ファイル情報

- **パス**: \`<file_path>\`
- **種別**: <種別名> (<種別コード>)
- **行数**: <行数>行
- **関数数**: <関数数>個
- **最終更新**: <日付> (git log より)

---

### 総合評価

| 観点               | 評価   | スコア     |
| ------------------ | ------ | ---------- |
| 型安全性           | <評価> | <スコア>/3 |
| 命名規則           | <評価> | <スコア>/3 |
| 関数の長さ         | <評価> | <スコア>/3 |
| 重複コード         | <評価> | <スコア>/3 |
| 単一責任           | <評価> | <スコア>/3 |
| 引数の数           | <評価> | <スコア>/3 |
| マジックナンバー   | <評価> | <スコア>/3 |
| コメントの適切性   | <評価> | <スコア>/3 |
| エラーハンドリング | <評価> | <スコア>/3 |
| セキュリティ       | <評価> | <スコア>/3 |
| 非同期処理         | <評価> | <スコア>/3 |

**総合スコア**: <合計>/<満点> (<パーセント>%)

---

### ✅ 良い点

- ✅ <具体的な良い点1>
- ✅ <具体的な良い点2>
- ✅ <具体的な良い点3>
  （最低3つ、できれば5つ以上）

---

### ⚠️ 改善が必要な点

#### [必須] 重大な問題

<問題がない場合は「なし」>

- ❌ **<問題の概要>**
  - **箇所**: <ファイルパス:行番号>
  - **理由**: <なぜ問題か>
  - **改善案**: <具体的な改善方法>

#### [推奨] 改善推奨

- 📝 **<問題の概要>**
  - **箇所**: <ファイルパス:行番号>
  - **改善案**: <改善案の詳細>

#### [提案] さらなる改善

- 💡 **<提案の概要>**
  - **箇所**: <ファイルパス:行番号>
  - **提案内容**: <提案の詳細とメリット>

---

### プロジェクトルールへの準拠

✅/⚠️/❌ **TypeScript 共通 (import 順序)**: <チェック結果>
✅/⚠️/❌ **Backend/Frontend (日本語コメント)**: <チェック結果>

---

### 次のステップ

#### 優先度: 高

1. <最優先で対応すべきこと>

#### 優先度: 中

2. <次に対応すべきこと>

#### 優先度: 低

3. <時間があれば対応すること>

---

### レビュー完了

<総評コメント>
\`\`\`

#### 評価基準

**スコア基準**:

- 3点: 優秀（問題なし）
- 2点: 良好（軽微な問題あり）
- 1点: 改善が必要（複数の問題あり）
- 0点: 重大な問題あり

**評価ラベル**:

- ✅ 良好
- ⚠️ 改善推奨
- ❌ 問題あり

---

## レビューの姿勢

レビュー実行時は以下の姿勢を徹底すること：

- **建設的**: 批判ではなく、改善のための提案を行う
- **具体的**: 「わかりにくい」ではなく、「どこが」「なぜ」「どう改善するか」を明示
- **バランス**: 悪い点だけでなく、良い点も必ず指摘する（最低3つ）
- **実用的**: 実際に実行可能な改善案を提示する
- **根拠**: 改善提案には必ず理由を添える

**良い指摘の例**:

\`\`\`
📝 **マジックナンバー**: login.ts:78 の \`300000\` は意図が不明確です。

- \`const TIMEOUT_MS = 300000\` のように定数化することで、
  意図が明確になり、他の箇所でも再利用できます
  \`\`\`

**避けるべき指摘の例**:

\`\`\`
❌ 「この部分がわかりにくい」（具体性がない）
❌ 「もっと詳しく書くべき」（改善案が不明確）
\`\`\`

---

## エラーハンドリング

| エラーケース         | 対応                                                                         |
| -------------------- | ---------------------------------------------------------------------------- |
| ファイルが存在しない | 「指定されたファイルが見つかりません: <path>」と表示して終了                 |
| ファイルが空         | 「ファイルが空です」と表示して終了                                           |
| Glob で0件           | 「backend/src/, frontend/src/ 配下にファイルが見つかりません」と表示して終了 |
| 無効な入力           | 再入力を促す（最大3回、それ以上はキャンセル）                                |
| git リポジトリでない | git 履歴の取得をスキップし、レビューは続行                                   |

---

## 使用可能なツール

| ツール   | 用途                                                           |
| -------- | -------------------------------------------------------------- |
| **Glob** | ファイル検出（`backend/src/**/*.ts`, `frontend/src/**/*.ts*`） |
| **Read** | ファイル内容の読み取り                                         |
| **Grep** | キーワード検索（`any`, マジックナンバー、セキュリティリスク）  |
| **Bash** | git log でファイル履歴確認                                     |
```

---

## Critical Files（重要なファイル）

実装時に作成するファイル:

### 新規作成

1. `.claude/skills/review/SKILL.md` - Code Review スキルの定義
2. `.claude/agents/code-reviewer-agent/code-reviewer-agent.md` - Code Reviewer エージェントの定義

---

## 検証方法

### 1. スキルの動作確認

```bash
/review
```

以下が正しく動作することを確認：

1. ファイル一覧が表示される
2. 番号選択でファイルを選択できる
3. レビュー結果が詳細なフォーマットで表示される

### 2. レビュー観点のテスト

#### テストケース 1: 型安全性チェック

`backend/src/handlers/login.ts` に `any` を追加してレビュー実行

**期待結果**: 「型安全性」項目で減点、改善提案が表示される

#### テストケース 2: マジックナンバーチェック

`backend/src/handlers/callback.ts` にハードコード数値を追加してレビュー実行

**期待結果**: 「マジックナンバー」項目で減点、定数化の提案が表示される

#### テストケース 3: import 順序チェック

`frontend/src/pages/IndexPage.tsx` の import 順序を変更してレビュー実行

**期待結果**: 「プロジェクトルールへの準拠」で ⚠️ 表示、正しい順序の提案が表示される

#### テストケース 4: セキュリティチェック

`backend/src/utils/secrets.ts` に `process.env.SECRET_KEY!` のような危険なコードを追加してレビュー実行

**期待結果**: 「セキュリティ」項目で減点、環境変数チェックの提案が表示される

### 3. エッジケースの確認

- 空のファイルを選択 → エラーメッセージ表示
- 存在しないファイルパスを入力 → エラーメッセージ表示
- キャンセル（空入力） → 正常終了

---

## 実装の優先順位

### Step 1: スキル定義ファイルの作成

1. `.claude/skills/review/` ディレクトリを作成
2. `SKILL.md` を作成
3. スキル定義の構文チェック

### Step 2: エージェント定義ファイルの作成

1. `.claude/agents/code-reviewer-agent/` ディレクトリを作成
2. `code-reviewer-agent.md` を作成
3. エージェント定義の構文チェック

### Step 3: 動作確認

1. `/review` コマンドを実行
2. 各レビュー観点が正しくチェックされることを確認
3. エラーケースの動作確認

---

## 将来的な拡張案（今回は実装しない）

1. **複数ファイル同時レビュー**: 複数ファイルを選択してバッチレビュー
2. **git diff ベースのレビュー**: 変更されたファイルのみを自動検出してレビュー
3. **自動修正機能**: import 順序などの軽微な問題を自動修正
4. **カスタムルールの追加**: プロジェクト固有のルールを追加可能に
5. **IDE 統合**: VSCode 拡張として統合

---

## 参考情報

- 既存実装: `/doc-reviewer` スキル・エージェント
- プロジェクトルール: `.claude/rules/typescript.md`, `.claude/rules/backend.md`, `.claude/rules/frontend.md`
- 開発フロー: `CLAUDE.md` の Step 6.1
