# Issue #18: `/review` スラッシュコマンド実装計画

### 関連ドキュメント

- 📝 Plan: [review.md](../plan/review.md)

## 📂 コンテキスト (Context)

> Claudeが調査を開始する起点となるファイルやディレクトリを指定します

- `.claude/skills/review/SKILL.md`
- `.claude/agents/code-reviewer-agent/code-reviewer-agent.md`

### 背景 / 目的

現在、Backend と Frontend の TypeScript アプリケーションコードをレビューする統合的なコマンドがありません。開発フロー（CLAUDE.md）の Step 6.1 に `/review` が記載されていますが、未実装の状態です。

コードレビューは以下の観点で重要です：

- **コード品質の維持**: 型安全性、命名規則、関数の長さなどの基本的な品質指標
- **設計原則の遵守**: 単一責任の原則、DRY 原則、適切な抽象化
- **セキュリティリスクの低減**: ハードコード、インジェクション脆弱性の早期発見
- **プロジェクトルールの準拠**: import 順序、日本語コメントなどのプロジェクト固有ルール
- **レビューの一貫性**: 人間によるレビューの前に、機械的にチェックできる項目を自動化

この実装により、`/review` コマンド一つで TypeScript コードの詳細なレビューを実行し、型安全性、設計原則、セキュリティ、プロジェクトルール準拠を自動チェックできるようになります。改善提案は「必須/推奨/提案」の3段階で分類され、優先度が明確化されます。

### スコープ / 作業項目

#### Phase 1: スキル定義ファイルの作成

**作成するファイル**: `.claude/skills/review/SKILL.md`

以下の要素を含むスキル定義を作成：

- スキル名: `review`
- 説明: Backend と Frontend の TypeScript アプリケーションコードをレビュー
- レビュー対象: `backend/src/**/*.ts`, `frontend/src/**/*.tsx`（テストコードとCDKコードは除外）
- 処理内容:
  1. レビュー対象ファイルの検出と選択
  2. コード種別の自動判定（Handler/Utility/Page/Context）
  3. レビュー観点に基づく評価（型安全性、命名規則、関数の長さ、重複コード、単一責任、引数の数、マジックナンバー、コメント、エラーハンドリング、セキュリティ、非同期処理）
  4. 詳細レポート生成（総合評価、良い点、改善点、次のステップ）
- エージェント起動: `code-reviewer-agent` をTaskツールで起動
- レビューの姿勢: 建設的、具体的、バランス、実用的、根拠

#### Phase 2: エージェント定義ファイルの作成

**作成するファイル**: `.claude/agents/code-reviewer-agent/code-reviewer-agent.md`

以下の処理フローを実装：

**Phase 1: ファイル検出とインタラクティブ選択**

- Globツールで `backend/src/**/*.ts`, `frontend/src/**/*.ts*` を検出
- テストコード（`**/*.test.ts`, `**/*.test.tsx`）を除外
- ファイル一覧を種別ごとに表示（Handlers/Utilities/Pages/Contexts）
- ユーザー入力（番号またはパス）を受け付け

**Phase 2: コード種別の判定**

- ファイルパスから種別を判定（Backend Handler/Utility, Frontend Page/Context/Utility）

**Phase 3: レビュー観点の選択**

- 共通観点（11項目）: 型安全性、命名規則、関数の長さ、重複コード、単一責任、引数の数、マジックナンバー、コメント、エラーハンドリング、セキュリティ、非同期処理
- プロジェクトルール準拠: import順序、日本語コメント

**Phase 4: レビュー実行**

- Readツールでファイル内容を取得
- Bashツールで git log から変更履歴を確認
- 各観点をチェック（Grepで型安全性、マジックナンバー、セキュリティリスクを検索）
- 3点満点でスコアリング

**Phase 5: 結果出力**

- 総合評価とスコア
- 良い点（最低3つ）
- 改善が必要な点（必須/推奨/提案の3段階）
- プロジェクトルールへの準拠状況
- 次のステップ（優先度付き）

### ゴール / 完了条件（Acceptance Criteria）

- [ ] `.claude/skills/review/SKILL.md` を作成
- [ ] `.claude/agents/code-reviewer-agent/code-reviewer-agent.md` を作成
- [ ] `/review` コマンドでファイル一覧が表示される
- [ ] 番号選択でファイルを選択できる
- [ ] レビュー結果が詳細なフォーマットで表示される（総合評価、良い点、改善点、次のステップ）
- [ ] 型安全性、マジックナンバー、import順序などの観点が正しくチェックされる

### テスト観点

#### 1. スキルの動作確認

```bash
/review
```

以下が正しく動作することを確認：

1. ファイル一覧が表示される
2. 番号選択でファイルを選択できる
3. レビュー結果が詳細なフォーマットで表示される

#### 2. レビュー観点のテスト

**テストケース 1: 型安全性チェック**

- `backend/src/handlers/login.ts` に `any` を追加してレビュー実行
- 期待結果: 「型安全性」項目で減点、改善提案が表示される

**テストケース 2: マジックナンバーチェック**

- `backend/src/handlers/callback.ts` にハードコード数値を追加してレビュー実行
- 期待結果: 「マジックナンバー」項目で減点、定数化の提案が表示される

**テストケース 3: import 順序チェック**

- `frontend/src/pages/IndexPage.tsx` の import 順序を変更してレビュー実行
- 期待結果: 「プロジェクトルールへの準拠」で ⚠️ 表示、正しい順序の提案が表示される

**テストケース 4: セキュリティチェック**

- `backend/src/utils/secrets.ts` に `process.env.SECRET_KEY!` のような危険なコードを追加してレビュー実行
- 期待結果: 「セキュリティ」項目で減点、環境変数チェックの提案が表示される

#### 3. エッジケースの確認

- 空のファイルを選択 → エラーメッセージ表示
- 存在しないファイルパスを入力 → エラーメッセージ表示
- キャンセル（空入力） → 正常終了

（必要なら）要確認事項:

- （なし）
